## 主从+哨兵

- Redis集群的主从复制模型是怎样的？
一主多从节点
- 全量复制的三个阶段？
主进程cow生成RDB文件
网络发送RDB文件
从节点清理数据, 但是这个时候节点发生bgsave 也回带来资源的浪费或者叫做阻塞
- 为什么会设计增量复制？
同步失败的情况,又不能再重复同步一次.
- 增量复制的流程？ 如果在网络断开期间，repl_backlog_size环形缓冲区写满之后，从库是会丢失掉那部分被覆盖掉的数据，还是直接进行全量复制呢？
继续增量复制
- 为什么不持久化的主服务器自动重启非常危险呢?
废话
- 为什么主从全量复制使用RDB而不使用AOF？
废话
- 为什么还会有从库的从库的设计？
备胎的备胎(多个备胎多条路)

### 啥是哨兵？
哨兵就是监听主节点的存活状态,保证正常运行,如果主节点挂掉,哨兵会立马从子节点上选举一个子节点作为主节点。
● 新的主库选择出来后，如何进行故障的转移？
哨兵集群在发现master node挂掉后会进行故障转移，也就是启动其中一个slave node为master node。在这过程中，可能会导致数据丢失的情况。

异步复制导致数据丢失

因为master->slave的复制是异步，所以有可能部分还没来得及复制到slave就宕机了，此时这些部分数据就丢失了。

集群脑裂导致数据丢失

脑裂，也就是说。某个master所在机器突然脱离了正常的网络，跟其它slave机器不能连接，但是实际上master还运行着。

造成的问题：

此时哨兵可能就会认为master宕机了，然后开始选举，将其它slave切换成master。这时候集群里就会有2个master，也就是所谓的脑裂。此时虽然某个slave被切换成master，但是可能client还没来得及切换成新的master，还继续写向旧的master的数据可能就丢失了。因此旧master再次被恢复的时候，会被作为一个slave挂到新的master上去，自己的数据会被清空，重新从新的master复制数据。
怎么解决：
min-slaves-to-write 1
min-slaves-max-lag 10
要求至少有一个slave，数据复制和同步的延迟不能超过10s。
如果说一旦所有的slave，数据复制和同步的延迟都超过了10s，这个时候，master就不会再接收任何请求了

## 集群
> 分治法的思想,将数据拆成多个部分,一个机器上放一部分
- 说说Redis哈希槽的概念？为什么是16384个？(套路)
  每个 key 通过 CRC16 校验后对 16384 取模来决定放置哪个槽，
  
  如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大。
  如上所述，在消息头中，最占空间的是myslots[CLUSTER_SLOTS/8]。
  当槽位为65536时，这块的大小是:
  65536÷8÷1024=8kb
  因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。
  

